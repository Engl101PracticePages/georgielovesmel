<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Georgie Loves Mel</title>

<style>
:root{
  color-scheme: dark;
  --bg:#0b1020;
  --card:#101a33;
  --ink:#eef2ff;
  --muted:#c7d2fe;
  --line:#243055;
  --accent:#8aa4ff;
  --accent2:#a7b8ff;
  --warn:#ffb4a9;
  --good:#7dffa8;
  --shadow:0 18px 40px rgba(0,0,0,.45);
  --focus:3px solid rgba(138,164,255,.65);
  --radius:20px;
  --base:20px;
}

html{ font-size:var(--base); }
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  background: radial-gradient(1200px 800px at 20% -10%, rgba(138,164,255,.18), transparent 55%),
              radial-gradient(900px 700px at 90% 10%, rgba(167,184,255,.10), transparent 55%),
              var(--bg);
  color:var(--ink);
  line-height:1.55;
}

.wrap{
  max-width: 900px;
  margin: 0 auto;
  padding: 34px 18px 70px;
}

.card{
  background: rgba(16,26,51,.92);
  border: 1px solid rgba(36,48,85,.9);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 22px;
  margin-top: 16px;
  backdrop-filter: blur(6px);
}

h1{
  margin: 0 0 10px 0;
  font-size: 1.75rem;
  letter-spacing: .2px;
}

.sub{
  margin: 0;
  color: var(--muted);
}

.grid{
  display:grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-top: 16px;
}

@media (min-width: 760px){
  .grid{ grid-template-columns: 1fr 1fr; }
}

.btn{
  appearance:none;
  border: 1px solid rgba(36,48,85,.95);
  background: rgba(12,18,36,.55);
  color: var(--ink);
  border-radius: 18px;
  padding: 18px 16px;
  min-height: 58px;
  font: inherit;
  cursor: pointer;
  text-align: left;
  transition: transform .06s ease, background .2s ease, border-color .2s ease;
}

.btn:hover{
  background: rgba(12,18,36,.72);
  border-color: rgba(138,164,255,.45);
}

.btn:active{ transform: translateY(1px); }

.btn:focus, a:focus{
  outline: var(--focus);
  outline-offset: 3px;
}

.btn strong{
  display:block;
  font-weight: 700;
  font-size: 1.05rem;
}

.btn span{
  display:block;
  color: var(--muted);
  margin-top: 4px;
  font-size: .95rem;
}

.result{
  margin-top: 16px;
  font-size: 1.35rem;
}

.result a{
  color: var(--accent2);
  text-decoration: none;
  border-bottom: 1px solid rgba(167,184,255,.35);
}

.meta{
  margin-top: 10px;
  color: var(--muted);
  font-size: .98rem;
}

.badge{
  display:inline-block;
  padding: 7px 10px;
  border-radius: 999px;
  border: 1px solid rgba(36,48,85,.95);
  background: rgba(12,18,36,.55);
  font-size: .95rem;
  margin-top: 10px;
  margin-right: 8px;
}

.badge.good{ color: var(--good); border-color: rgba(125,255,168,.25); }
.badge.warn{ color: var(--warn); border-color: rgba(255,180,169,.25); }

.small{
  color: var(--muted);
  margin-top: 10px;
  font-size: .95rem;
}

.links{
  display:flex;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
  align-items:center;
}

a{
  color: var(--accent2);
  text-decoration: none;
}
a:hover{
  text-decoration: underline;
}
</style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h1>Hi Mel. This is our little dinner oracle.</h1>
    <p class="sub">One choice. No spiral.</p>

    <div class="grid" role="group" aria-label="Pick buttons">
      <button class="btn" type="button" onclick="pick('food')">
        <strong>Pick food</strong>
        <span>Only shows places open right now</span>
      </button>

      <button class="btn" type="button" onclick="pick('dessert')">
        <strong>Pick dessert</strong>
        <span>Only shows places open right now</span>
      </button>

      <button class="btn" type="button" onclick="pick('either')">
        <strong>Either</strong>
        <span>Food or dessert, open right now</span>
      </button>

      <button class="btn" type="button" onclick="pick(lastMode, true)" id="rerollBtn" disabled>
        <strong>Reroll</strong>
        <span>Show a different open option</span>
      </button>
    </div>

    <div class="result" id="result">No pick yet.</div>
    <div id="badges"></div>
    <div class="meta" id="meta"></div>
    <div class="small" id="status"></div>
  </div>

  <div class="card">
    <div class="links">
      <a href="./add.html">Add a place</a>
      <span class="small" id="dataStamp"></span>
    </div>
  </div>

</div>

<script>
const CLOSING_SOON_MIN = 45;

let restaurants = [];
let lastMode = "either";
let generatedAt = null;

function norm(s){
  return (s || "").toString().trim().toLowerCase();
}

function minutesUntil(iso){
  if(!iso) return null;
  const t = new Date(iso).getTime();
  if(!Number.isFinite(t)) return null;
  const mins = Math.round((t - Date.now()) / 60000);
  return Number.isFinite(mins) ? mins : null;
}

function badge(text, cls){
  const div = document.createElement("span");
  div.className = `badge ${cls || ""}`.trim();
  div.textContent = text;
  return div;
}

async function load(){
  try{
    const res = await fetch("restaurants.json", { cache: "no-store" });
    const data = await res.json();
    restaurants = Array.isArray(data.restaurants) ? data.restaurants : [];
    generatedAt = data.generated_at || null;

    if(generatedAt){
      const dt = new Date(generatedAt);
      document.getElementById("dataStamp").textContent = `Updated ${dt.toLocaleString()}`;
    }

    if(!restaurants.length){
      document.getElementById("status").innerText = "No restaurants yet. Add a few to the Sheet, then rerun the workflow.";
    }
  }catch(e){
    document.getElementById("status").innerText = "No data yet. Add restaurants, then rerun the workflow.";
  }
}

function pickFrom(pool){
  return pool[Math.floor(Math.random() * pool.length)];
}

function soonestOpener(all, mode){
  const pool = all.filter(r => {
    const cat = norm(r.category);
    if(mode === "either") return true;
    return cat === mode;
  });

  // Best effort: choose the one with the smallest positive minutes until close/open.
  // We have next_close_iso but not next_open_iso. If everything is closed, we at least show a place
  // and label it as closed with "check hours in Maps."
  //
  // If we later add next_open_iso in the updater, this will become truly "soonest opening."
  return pool.length ? pickFrom(pool) : null;
}

function render(r, context){
  const resultEl = document.getElementById("result");
  const badgesEl = document.getElementById("badges");
  const metaEl = document.getElementById("meta");

  badgesEl.innerHTML = "";
  metaEl.textContent = "";

  if(!r){
    resultEl.textContent = "No matches.";
    return;
  }

  const url = r.google_maps_url || r.url || "#";
  const name = r.name || "Unnamed place";
  resultEl.innerHTML = `<a href="${url}" target="_blank" rel="noopener noreferrer">${name}</a>`;

  if(r.notes) metaEl.textContent = r.notes;

  const openNow = (r.open_now === true);
  if(openNow){
    badgesEl.appendChild(badge("Open now", "good"));

    const mins = minutesUntil(r.next_close_iso);
    if(mins !== null && mins >= 0 && mins <= CLOSING_SOON_MIN){
      badgesEl.appendChild(badge(`Closing soon (${mins} min)`, "warn"));
    }
  }else{
    badgesEl.appendChild(badge("Closed right now", "warn"));
    if(context === "fallback"){
      metaEl.textContent = "Everything looks closed right now. This is the best guess. Please confirm in Maps.";
    }else{
      metaEl.textContent = "This should not appear often. If it does, rerun the workflow or confirm in Maps.";
    }
  }
}

function pick(mode, isReroll=false){
  lastMode = mode;

  const rerollBtn = document.getElementById("rerollBtn");
  if(rerollBtn) rerollBtn.disabled = false;

  const all = restaurants;

  const openPool = all.filter(r => {
    const cat = norm(r.category);
    const catOk = (mode === "either") ? true : (cat === mode);
    return catOk && (r.open_now === true);
  });

  if(openPool.length){
    const r = pickFrom(openPool);
    render(r, "normal");
    return;
  }

  // Fallback behavior you chose: when everything is closed, show the soonest-opening place.
  // We do not have next_open_iso yet, so we show a best-guess from the category pool
  // and label it clearly "confirm in Maps."
  const fallback = soonestOpener(all, mode);
  render(fallback, "fallback");
}

load();
</script>
</body>
</html>
